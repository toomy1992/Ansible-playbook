---
# Rundeck Hosts Configuration Playbook
# Deploy essentials + PostgreSQL database + Rundeck on rundeck_hosts group (NO Docker)
#
# This playbook installs and configures:
# - Essential system packages and configuration
# - PostgreSQL database for Rundeck (production-ready backend)
# - Rundeck automation server (open source)
# - Security hardening (AppArmor, integrity monitoring, malware scanning)
# - Full monitoring stack (Prometheus, Loki, Grafana Agent, Alertmanager)
#
# Usage:
#   ansible-playbook playbooks/rundeck-hosts.yml
#   ansible-playbook playbooks/rundeck-hosts.yml --tags "rundeck,rundeck-postgres"
#   ansible-playbook playbooks/rundeck-hosts.yml --check --diff

- name: Configure Rundeck hosts
  hosts: rundeck_hosts
  gather_facts: yes
  
  pre_tasks:
    - name: Display rundeck host configuration
      debug:
        msg: "Configuring Rundeck host: {{ inventory_hostname }}"

    - name: Verify database password is set for PostgreSQL
      assert:
        that:
          - rundeck_db_password is defined
          - rundeck_db_password | length > 0
        fail_msg: "PostgreSQL password must be set via vault_rundeck_db_password or rundeck_db_password"
      when: rundeck_database_backend | default('postgresql') == 'postgresql'
      tags: [rundeck-postgres]

  roles:
    # ===========================================
    # LAYER 1: ESSENTIALS
    # ===========================================
    - role: apt
      tags: [apt, essentials]
    - role: packages
      tags: [packages, essentials]
    - role: user_accounts
      tags: [users, essentials]
    - role: users_ops
      tags: [users-ops, essentials]
    - role: ssh
      tags: [ssh, essentials]
    - role: timezone
      tags: [timezone, essentials]
    - role: hostname
      tags: [hostname, essentials]
    - role: firewall
      tags: [firewall, essentials]
    - role: mail
      tags: [mail, essentials]
    - role: updates
      tags: [updates, essentials]

    # ===========================================
    # LAYER 2: RUNDECK DATABASE (PostgreSQL)
    # ===========================================
    - role: rundeck_postgres
      tags: [rundeck-postgres, database]
      when: rundeck_database_backend | default('postgresql') == 'postgresql'

    # ===========================================
    # LAYER 3: RUNDECK APPLICATION
    # ===========================================
    - role: rundeck
      tags: [rundeck, application]

    # ===========================================
    # LAYER 4: SECURITY HARDENING
    # ===========================================
    - role: apparmor
      tags: [apparmor, security]
    - role: malware_scanning
      tags: [malware-scanning, security]
    - role: security_audits
      tags: [security-audits, security]
    #TODO: ADD OSSEC SERVER Playbook + update integrity_monitoring to integrity_monitoring_agent
    #- role: integrity_monitoring
    #  tags: [integrity-monitoring, security]

    # ===========================================
    # LAYER 5: MONITORING STACK
    # ===========================================
    - role: log_rotation
      tags: [log-rotation, monitoring]
    - role: loki
      tags: [loki, monitoring]
    - role: prometheus
      tags: [prometheus, monitoring]
    - role: grafana_agent
      tags: [grafana-agent, monitoring]
    - role: alertmanager
      tags: [alertmanager, monitoring]

  post_tasks:
    - name: Display Rundeck host completion summary
      debug:
        msg: |
          ============================================================
          Rundeck host {{ inventory_hostname }} configured successfully
          ============================================================
          
          Rundeck URL: {{ rundeck_grails_url | default('http://localhost:4440') }}
          Database Backend: {{ rundeck_database_backend | default('postgresql') }}
          {% if rundeck_database_backend | default('postgresql') == 'postgresql' %}
          PostgreSQL: {{ rundeck_db_host | default('localhost') }}:{{ rundeck_db_port | default(5432) }}/{{ rundeck_db_name | default('rundeck') }}
          {% endif %}
          
          Next Steps:
          1. Access Rundeck at {{ rundeck_grails_url | default('http://localhost:4440') }}
          2. Login with configured user credentials
          3. Create your first project
          ============================================================

