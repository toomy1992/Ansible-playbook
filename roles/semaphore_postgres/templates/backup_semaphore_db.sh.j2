#!/bin/bash
# Semaphore PostgreSQL Database Backup Script
# Generated by Ansible semaphore_postgres role

set -e

BACKUP_DIR="{{ semaphore_postgres_backup_dir }}"
DB_NAME="{{ semaphore_postgres_db_name }}"
DB_USER="{{ semaphore_postgres_db_user }}"
RETENTION_DAYS={{ semaphore_postgres_backup_retention_days }}

TIMESTAMP=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/semaphore_backup_${TIMESTAMP}.sql"

# Create backup directory if it doesn't exist
mkdir -p "$BACKUP_DIR"

# Perform backup
pg_dump -h localhost -U "$DB_USER" -d "$DB_NAME" > "$BACKUP_FILE"

# Compress backup
gzip "$BACKUP_FILE"

# Clean up old backups
find "$BACKUP_DIR" -name "semaphore_backup_*.sql.gz" -mtime +$RETENTION_DAYS -delete

echo "Semaphore database backup completed: ${BACKUP_FILE}.gz"