---
# Integrity Monitoring role - OSSEC installation and configuration

- name: Install dependencies
  apt:
    name:
      - build-essential
      - git
      - sqlite3
      - libsqlite3-dev
    state: present
  become: yes
  tags:
    - integrity-monitoring

- name: Clone OSSEC repository
  git:
    repo: https://github.com/ossec/ossec-hids.git
    dest: /opt/ossec-build
    version: "{{ ossec_version | default('3.7.0') }}"
  become: yes
  tags:
    - integrity-monitoring

- name: Run OSSEC preloaded installation
  shell: |
    cd /opt/ossec-build
    ./install.sh << EOF
    en
    agent
    n
    n
    y
    n
    EOF
  args:
    creates: /var/ossec
  become: yes
  tags:
    - integrity-monitoring

- name: Create OSSEC client.keys directory
  file:
    path: /var/ossec/etc/client.keys
    state: directory
    owner: root
    group: ossec
    mode: '0640'
  become: yes
  tags:
    - integrity-monitoring

- name: Configure OSSEC agent
  template:
    src: ossec-agent.conf.j2
    dest: /var/ossec/etc/ossec.conf
    owner: root
    group: ossec
    mode: '0640'
    backup: yes
  become: yes
  notify: Restart OSSEC
  tags:
    - integrity-monitoring

- name: Create OSSEC log rotation config
  copy:
    content: |
      /var/ossec/logs/alerts/alerts.log {
          daily
          rotate 10
          missingok
          notifempty
          compress
          delaycompress
          postrotate
              /var/ossec/bin/ossec-control signal hup
          endscript
      }
    dest: /etc/logrotate.d/ossec
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - integrity-monitoring

- name: Enable and start OSSEC service
  service:
    name: ossec
    state: started
    enabled: yes
  become: yes
  tags:
    - integrity-monitoring

- name: Create drop-in directory for ossec
  file:
    path: /etc/systemd/system/ossec.service.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes

- name: Set systemd timeout for ossec
  copy:
    content: |
      [Service]
      TimeoutStopSec=150s
    dest: /etc/systemd/system/ossec.service.d/timeout.conf
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify: Reload systemd daemon
  tags:
    - integrity-monitoring

- name: Create daily OSSEC report script
  copy:
    content: |
      #!/bin/bash
      # Daily OSSEC integrity report
      
      REPORT_DIR="/var/ossec/logs/reports"
      MAIL_SUBJECT="OSSEC Daily Integrity Report - $(hostname)"
      
      mkdir -p $REPORT_DIR
      
      TIMESTAMP=$(date +\%Y\%m\d_\%H\%M\%S)
      REPORT_FILE="$REPORT_DIR/integrity_report_$TIMESTAMP.txt"
      
      {
          echo "OSSEC Integrity Monitoring Report"
          echo "=================================="
          echo "Generated: $(date)"
          echo "Hostname: $(hostname)"
          echo ""
          echo "Alert Summary:"
          tail -50 /var/ossec/logs/alerts/alerts.log | grep -E "File added|File modified|File deleted|Unable to check file"
          echo ""
          echo "OSSEC Status:"
          /var/ossec/bin/agent_control -i
      } > "$REPORT_FILE"
      
      # Send email if configured
      if [ "{{ ossec_email_notifications | default(false) | lower }}" = "true" ]; then
          mail -s "$MAIL_SUBJECT" "{{ ossec_admin_email | default('root') }}" < "$REPORT_FILE"
      fi
    dest: /usr/local/bin/ossec-daily-report.sh
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - integrity-monitoring

- name: Schedule daily OSSEC reports
  cron:
    name: "OSSEC Daily Integrity Report"
    hour: "{{ ossec_report_hour | default(6) }}"
    minute: "{{ ossec_report_minute | default(0) }}"
    job: "/usr/local/bin/ossec-daily-report.sh"
    user: root
    cron_file: ossec-reports
  become: yes
  tags:
    - integrity-monitoring

- name: Verify OSSEC installation
  shell: /var/ossec/bin/agent_control -l
  register: ossec_status
  changed_when: false
  become: yes
  tags:
    - integrity-monitoring
