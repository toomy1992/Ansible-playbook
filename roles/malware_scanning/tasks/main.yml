---
# Malware Scanning role - Maldet installation and daily scanning

- name: Install malware scanning dependencies
  apt:
    name:
      - curl
      - perl
      - rsync
      - inotify-tools
    state: present
  become: yes
  tags:
    - malware-scanning

- name: Download Maldet
  shell: |
    cd /tmp
    curl -L "http://www.rfxn.com/downloads/maldetect-current.tar.gz" -o maldetect.tar.gz
    tar xzf maldetect.tar.gz
  args:
    creates: /tmp/maldetect-{{ maldet_version }}/
  become: yes
  tags:
    - malware-scanning

- name: Install Maldet
  shell: |
    cd /tmp/maldetect-*/
    ./install.sh
  args:
    creates: /usr/local/maldetect
  become: yes
  tags:
    - malware-scanning

- name: Create Maldet configuration directory
  file:
    path: /usr/local/maldetect/conf.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - malware-scanning

- name: Configure Maldet
  template:
    src: maldet.conf.j2
    dest: /usr/local/maldetect/conf.d/maldet-custom.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  become: yes
  tags:
    - malware-scanning

- name: Update Maldet signature database
  shell: /usr/local/sbin/maldet --update
  become: yes
  changed_when: false
  tags:
    - malware-scanning

- name: Create daily Maldet scan script
  copy:
    content: |
      #!/bin/bash
      # Daily Maldet malware scanning and reporting
      
      SCAN_DIR="{{ maldet_scan_paths | join(' ') }}"
      REPORT_DIR="/var/log/maldet-reports"
      MAIL_SUBJECT="Maldet Daily Scan Report - $(hostname)"
      
      mkdir -p $REPORT_DIR
      
      TIMESTAMP=$(date +\%Y\%m\d_\%H\%M\%S)
      REPORT_FILE="$REPORT_DIR/maldet_report_$TIMESTAMP.txt"
      
      {
          echo "Maldet Malware Scan Report"
          echo "=========================="
          echo "Generated: $(date)"
          echo "Hostname: $(hostname)"
          echo ""
          echo "Scanning directories:"
          for dir in $SCAN_DIR; do
              echo "  - $dir"
          done
          echo ""
          echo "Scan Results:"
          /usr/local/sbin/maldet -a $SCAN_DIR 2>&1 | tail -20
          echo ""
          echo "Recent Detections (last 10 scans):"
          ls -lt $(/usr/local/maldetect/logs/event_log | tail -10) 2>/dev/null || echo "No detections"
      } > "$REPORT_FILE"
      
      # Keep only last 30 days of reports
      find $REPORT_DIR -type f -mtime +30 -delete
      
      # Send email if configured
      if [ "{{ maldet_email_notifications | default(false) | lower }}" = "true" ]; then
          mail -s "$MAIL_SUBJECT" "{{ maldet_admin_email | default('root') }}" < "$REPORT_FILE"
      fi
    dest: /usr/local/bin/maldet-daily-scan.sh
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - malware-scanning

- name: Schedule daily Maldet scans
  cron:
    name: "Maldet Daily Malware Scan"
    hour: "{{ maldet_scan_hour | default(2) }}"
    minute: "{{ maldet_scan_minute | default(0) }}"
    job: "/usr/local/bin/maldet-daily-scan.sh"
    user: root
    cron_file: maldet-scans
  become: yes
  tags:
    - malware-scanning

- name: Enable Maldet signature updates
  cron:
    name: "Maldet Signature Update"
    hour: "{{ maldet_update_hour | default(0) }}"
    minute: "{{ maldet_update_minute | default(30) }}"
    job: "/usr/local/sbin/maldet --update"
    user: root
    cron_file: maldet-updates
  become: yes
  tags:
    - malware-scanning

- name: Create Maldet quarantine directory
  file:
    path: /var/log/maldet-quarantine
    state: directory
    owner: root
    group: root
    mode: '0700'
  become: yes
  tags:
    - malware-scanning

- name: Verify Maldet installation
  shell: /usr/local/sbin/maldet --version
  register: maldet_version_check
  changed_when: false
  become: yes
  tags:
    - malware-scanning
