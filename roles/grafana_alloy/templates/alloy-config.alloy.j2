// Grafana Alloy Configuration
// Unified observability backend for metrics and logs

logging {
  level  = "{{ grafana_alloy_log_level }}"
  format = "json"
}

// ===== METRICS COLLECTION =====

// Prometheus node_exporter integration - exports system metrics
prometheus.exporter.unix "node" {
}

// Scrape node metrics and forward to Prometheus
prometheus.scrape "node" {
  targets    = prometheus.exporter.unix.node.targets
  forward_to = [prometheus.remote_write.grafana_cloud.receiver]
  scrape_interval = "{{ grafana_alloy_scrape_interval }}"
  scrape_timeout  = "{{ grafana_alloy_scrape_timeout }}"
}

// Send metrics to Prometheus remote write endpoint
prometheus.remote_write "grafana_cloud" {
  endpoint {
    url = "{{ prometheus_push_url }}"
  }
}

// ===== LOGS COLLECTION =====

// Send logs to Loki
loki.write "grafana_cloud" {
  endpoint {
    url = "{{ loki_push_url }}"
  }
}

{% if grafana_alloy_collect_syslog %}
// Read syslog logs and send to Loki
loki.source.file "syslog" {
  targets = [
    {
      labels = {
        job  = "syslog",
        host = "{{ ansible_hostname }}",
      },
      __path__ = "/var/log/syslog",
    },
  ]
  forward_to = [loki.write.grafana_cloud.receiver]
}
{% endif %}

{% if grafana_alloy_collect_auth_logs %}
// Read auth logs and send to Loki
loki.source.file "auth" {
  targets = [
    {
      labels = {
        job  = "auth",
        host = "{{ ansible_hostname }}",
      },
      __path__ = "/var/log/auth.log",
    },
  ]
  forward_to = [loki.write.grafana_cloud.receiver]
}
{% endif %}
