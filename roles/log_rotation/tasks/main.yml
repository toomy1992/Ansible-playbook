---
# Log Rotation role - Manage log rotation with logrotate

- name: Install logrotate
  apt:
    name: logrotate
    state: present
  become: yes
  tags:
    - log-rotation
    - monitoring

- name: Create logrotate configuration directory
  file:
    path: /etc/logrotate.d
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - log-rotation
    - monitoring

- name: Configure system logs rotation
  copy:
    content: |
      /var/log/syslog
      /var/log/auth.log
      /var/log/kern.log
      {
          daily
          rotate {{ log_rotation_retention_days }}
          compress
          delaycompress
          notifempty
          missingok
          postrotate
              systemctl reload rsyslog > /dev/null 2>&1 || true
          endscript
      }
    dest: /etc/logrotate.d/system
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - log-rotation
    - monitoring

- name: Configure application logs rotation
  copy:
    content: |
      /var/log/*.log
      /var/log/**/*.log
      {
          daily
          rotate {{ log_rotation_retention_days }}
          compress
          delaycompress
          notifempty
          missingok
          maxage {{ log_rotation_max_age_days }}
          postrotate
              systemctl reload rsyslog > /dev/null 2>&1 || true
          endscript
      }
    dest: /etc/logrotate.d/application
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - log-rotation
    - monitoring

- name: Configure Ansible-specific log rotation
  copy:
    content: |
      /var/log/ansible.log
      {
          daily
          rotate {{ log_rotation_retention_days }}
          compress
          delaycompress
          notifempty
          missingok
          size {{ log_rotation_max_size }}
      }
    dest: /etc/logrotate.d/ansible
    owner: root
    group: root
    mode: '0644'
  become: yes
  tags:
    - log-rotation
    - monitoring

- name: Test logrotate configuration
  shell: logrotate -d /etc/logrotate.conf 2>&1 | head -20
  register: logrotate_test
  changed_when: false
  become: yes
  tags:
    - log-rotation
    - monitoring

- name: Schedule logrotate cron job
  cron:
    name: logrotate
    hour: "{{ log_rotation_cron_hour }}"
    minute: "{{ log_rotation_cron_minute }}"
    job: /usr/sbin/logrotate /etc/logrotate.conf
    user: root
    cron_file: logrotate-custom
  become: yes
  tags:
    - log-rotation
    - monitoring

- name: Configure compressed logs cleanup
  copy:
    content: |
      #!/bin/bash
      # Clean up old compressed logs
      find /var/log -name "*.gz" -type f -mtime +{{ log_rotation_max_age_days }} -delete
    dest: /etc/cron.daily/cleanup-old-logs
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - log-rotation
    - monitoring
