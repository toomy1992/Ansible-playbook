---
# Loki role - Log storage and aggregation

- name: Install dependencies
  apt:
    name:
      - curl
      - unzip
      - apache2-utils
    state: present
  become: yes
  tags:
    - loki
    - monitoring

- name: Create htpasswd file for Loki basic auth
  shell: |
    htpasswd -bc /etc/loki/.htpasswd "{{ loki_basic_auth_user }}" "{{ loki_basic_auth_password }}"
  when: loki_basic_auth_enabled | bool
  become: yes
  notify: Restart Loki
  tags:
    - loki
    - monitoring

- name: Create loki system user
  user:
    name: loki
    system: yes
    shell: /usr/sbin/nologin
    home: /var/lib/loki
  become: yes
  tags:
    - loki
    - monitoring

- name: Create loki directories
  file:
    path: "{{ item }}"
    state: directory
    owner: loki
    group: loki
    mode: '0755'
  loop:
    - /etc/loki
    - /var/lib/loki
    - /var/lib/loki/compactor
    - "{{ loki_wal_dir }}"
    - /var/log/loki
  become: yes
  tags:
    - loki
    - monitoring

- name: Check current Loki version
  shell: /usr/local/bin/loki --version 2>/dev/null | awk '{print $3}' || echo "none"
  register: current_loki_version
  changed_when: false
  failed_when: false
  become: yes
  tags:
    - loki
    - monitoring

- name: Download Loki binary (if version mismatch or not installed)
  shell: |
    cd /tmp
    LOKI_VERSION="{{ loki_version }}"
    wget -q https://github.com/grafana/loki/releases/download/v${LOKI_VERSION}/loki-linux-amd64.zip
    unzip -o loki-linux-amd64.zip
    mv loki-linux-amd64 /usr/local/bin/loki
    chmod +x /usr/local/bin/loki
  when: current_loki_version.stdout != loki_version
  become: yes
  notify: Restart Loki
  tags:
    - loki
    - monitoring

- name: Configure Loki
  template:
    src: loki-config.yml.j2
    dest: /etc/loki/loki-config.yml
    owner: loki
    group: loki
    mode: '0640'
    backup: yes
  become: yes
  notify: Restart Loki
  tags:
    - loki
    - monitoring

- name: Create Loki systemd service
  copy:
    content: |
      [Unit]
      Description=Loki Log Aggregation Service
      After=network.target

      [Service]
      Type=simple
      User=loki
      Group=loki
      ExecStart=/usr/local/bin/loki -config.file=/etc/loki/loki-config.yml
      Restart=on-failure
      RestartSec=10
      TimeoutStopSec=150s
      StandardOutput=journal
      StandardError=journal

      [Install]
      WantedBy=multi-user.target
    dest: /etc/systemd/system/loki.service
    owner: root
    group: root
    mode: '0644'
  become: yes
  notify: Restart Loki
  tags:
    - loki
    - monitoring

- name: Enable and start Loki service
  systemd:
    name: loki
    enabled: yes
    state: started
    daemon_reload: yes
  become: yes
  tags:
    - loki
    - monitoring

- name: Verify Loki service
  shell: curl -s http://localhost:3100/loki/api/v1/status/buildinfo || echo "Starting..."
  register: loki_status
  changed_when: false
  become: yes
  tags:
    - loki
    - monitoring
