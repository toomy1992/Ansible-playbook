---
# Security Audits role - Lynis installation and daily audits

- name: Install Lynis from Ubuntu repository
  apt:
    name: lynis
    state: present
    update_cache: yes
  become: yes
  tags:
    - security-audits

- name: Create Lynis configuration directory
  file:
    path: /etc/lynis
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - security-audits

- name: Configure Lynis
  copy:
    content: |
      # Lynis configuration file
      # Generated by Ansible
      
      # Config file location
      # config-file=/etc/lynis/lynis.conf
      
      # Auditor name
      auditor-name="{{ lynis_auditor_name | default('Security Team') }}"
      
      # Report style
      report-title="{{ lynis_report_title | default('System Security Audit Report') }}"
      
      # Plugins to include
      plugin-enabled=1
      
      # Quiet mode (less screen output)
      quiet={{ lynis_quiet_mode | default('0') }}
      
      # Log file
      logfile=/var/log/lynis.log
      
      # Options for deep scanning
      deep-inspection={{ lynis_deep_inspection | default('0') }}
    dest: /etc/lynis/lynis.conf
    owner: root
    group: root
    mode: '0644'
    backup: yes
  become: yes
  tags:
    - security-audits

- name: Create Lynis log directory
  file:
    path: /var/log/lynis-reports
    state: directory
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - security-audits

- name: Create daily Lynis audit script
  copy:
    content: |
      #!/bin/bash
      # Daily Lynis security audit and reporting
      
      REPORT_DIR="/var/log/lynis-reports"
      MAIL_SUBJECT="Lynis Daily Security Audit - $(hostname)"
      
      mkdir -p $REPORT_DIR
      
      TIMESTAMP=$(date +\%Y\%m\d_\%H\%M\%S)
      REPORT_FILE="$REPORT_DIR/lynis_audit_$TIMESTAMP.txt"
      
      # Run Lynis audit
      /usr/sbin/lynis audit system \
          --log=/var/log/lynis.log \
          --report-file=$REPORT_FILE \
          --quiet \
          {% for option in lynis_audit_options | default([]) %}
          {{ option }} \
          {% endfor %}
          2>&1
      
      # Generate summary report
      SUMMARY_FILE="$REPORT_DIR/audit_summary_$TIMESTAMP.txt"
      {
          echo "Lynis Daily Security Audit Summary"
          echo "===================================="
          echo "Generated: $(date)"
          echo "Hostname: $(hostname)"
          echo ""
          echo "Audit Status:"
          grep -E "Warnings found|Suggestions found|Hardening index" $REPORT_FILE || echo "Audit completed - see full report for details"
          echo ""
          echo "Top Issues:"
          grep "^\[W\]" $REPORT_FILE | head -10
          echo ""
          echo "Suggestions:"
          grep "^\[S\]" $REPORT_FILE | head -10
      } > "$SUMMARY_FILE"
      
      # Keep only last 30 days of reports
      find $REPORT_DIR -type f -mtime +30 -delete
      
      # Send email if configured
      if [ "{{ lynis_email_notifications | default(false) | lower }}" = "true" ]; then
          mail -s "$MAIL_SUBJECT" "{{ lynis_admin_email | default('root') }}" < "$SUMMARY_FILE"
      fi
    dest: /usr/local/bin/lynis-daily-audit.sh
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - security-audits

- name: Schedule daily Lynis audits
  cron:
    name: "Lynis Daily Security Audit"
    hour: "{{ lynis_audit_hour | default(4) }}"
    minute: "{{ lynis_audit_minute | default(0) }}"
    job: "/usr/local/bin/lynis-daily-audit.sh"
    user: root
    cron_file: lynis-audits
  become: yes
  tags:
    - security-audits

- name: Create Lynis baseline audit script
  copy:
    content: |
      #!/bin/bash
      # Lynis baseline security audit
      
      REPORT_DIR="/var/log/lynis-reports"
      BASELINE_FILE="$REPORT_DIR/baseline_audit_$(date +\%Y\%m\%d_\%H\%M\%S).txt"
      
      echo "Running Lynis baseline audit..."
      /usr/sbin/lynis audit system \
          --log=/var/log/lynis.log \
          --report-file=$BASELINE_FILE \
          --quiet \
          2>&1
      
      echo "Baseline audit complete: $BASELINE_FILE"
      echo "Review suggestions and implement hardening measures based on audit results"
    dest: /usr/local/bin/lynis-baseline-audit.sh
    owner: root
    group: root
    mode: '0755'
  become: yes
  tags:
    - security-audits

- name: Run initial Lynis baseline audit
  shell: /usr/local/bin/lynis-baseline-audit.sh
  register: lynis_baseline
  changed_when: false
  become: yes
  tags:
    - security-audits

- name: Verify Lynis installation
  shell: /usr/sbin/lynis --version
  register: lynis_version
  changed_when: false
  become: yes
  tags:
    - security-audits
