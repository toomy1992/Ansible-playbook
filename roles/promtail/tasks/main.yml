---
- name: Create Promtail config directory
  ansible.builtin.file:
    path: "{{ promtail_config_dir }}"
    state: directory
    mode: '0755'

- name: Generate Promtail configuration
  ansible.builtin.template:
    src: promtail-config.yml.j2
    dest: "{{ promtail_config_dir }}/promtail-config.yml"
    mode: '0644'
  notify: Restart Promtail container

- name: Deploy Promtail Docker container
  community.docker.docker_container:
    name: promtail
    image: "{{ promtail_image }}"
    state: started
    restart_policy: unless-stopped
    ports:
      - "{{ promtail_syslog_port }}:{{ promtail_syslog_port }}/tcp"
      - "{{ promtail_metrics_port }}:{{ promtail_metrics_port }}"
    volumes:
      - "{{ promtail_config_dir }}/promtail-config.yml:/etc/promtail/promtail-config.yml:ro"
      - /tmp:/tmp
    command: -config.file=/etc/promtail/promtail-config.yml
    networks:
      - name: mktxp
    recreate: yes