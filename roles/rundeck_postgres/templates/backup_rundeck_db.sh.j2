#!/bin/bash
# Rundeck PostgreSQL Database Backup Script
# Managed by Ansible - do not edit manually

set -euo pipefail

# Configuration
BACKUP_DIR="{{ rundeck_postgres_backup_dir }}"
DB_NAME="{{ rundeck_postgres_db_name }}"
DB_USER="{{ rundeck_postgres_db_user }}"
DB_HOST="{{ rundeck_postgres_host }}"
DB_PORT="{{ rundeck_postgres_port }}"
RETENTION_DAYS="{{ rundeck_postgres_backup_retention_days }}"
DATE=$(date +%Y%m%d_%H%M%S)
BACKUP_FILE="${BACKUP_DIR}/${DB_NAME}_${DATE}.sql.gz"

# Logging function
log() {
    echo "[$(date '+%Y-%m-%d %H:%M:%S')] $1"
}

# Ensure backup directory exists
mkdir -p "${BACKUP_DIR}"

log "Starting backup of Rundeck database: ${DB_NAME}"

# Perform backup
if pg_dump -h "${DB_HOST}" -p "${DB_PORT}" -U "${DB_USER}" -d "${DB_NAME}" | gzip > "${BACKUP_FILE}"; then
    log "Backup completed successfully: ${BACKUP_FILE}"
    log "Backup size: $(du -h "${BACKUP_FILE}" | cut -f1)"
else
    log "ERROR: Backup failed!"
    exit 1
fi

# Remove old backups
log "Cleaning up backups older than ${RETENTION_DAYS} days..."
find "${BACKUP_DIR}" -name "${DB_NAME}_*.sql.gz" -type f -mtime +${RETENTION_DAYS} -delete

# Count remaining backups
BACKUP_COUNT=$(find "${BACKUP_DIR}" -name "${DB_NAME}_*.sql.gz" -type f | wc -l)
log "Backup cleanup completed. ${BACKUP_COUNT} backups remaining."

log "Rundeck database backup completed successfully."
